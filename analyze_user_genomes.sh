#!/bin/bash

# This script assumes the user has:
#   *   A working R installation
#   *   A working python installation
#   *   Run-dbcan (specifically the train_many_organisms_many_families.py script)
#       *   Run-dbcan can be installed using the command: pip install run-dbcan
#   *   The following tools are in the users PATH
#       *   Mmseqs
#       *   Awk (preferably mawk aliased as awk)
#       *   Hmmer
#       *   gtdb-tk (can be installed using the command pip install gtdbtk)
#         *   prodigal (for gtdb-tk)
#         *   pplacer (for gtdb-tk)
#         *   FastANI (for gtdb-tk)
#         *   FastTree (for gtdb-tk)
#         *   Mash (for gtdb-tk)
#
#    
#   (*) The first argument is a path to the directory which contains a separate 
#         protein fasta file for each genome the user wishes to analyze
#   (*) The second argument is a path to the directory which contains genomic
#         fna files
#   (*) The optional third argument is a path to the directory which contains genomic

[ "$#" -lt 2 ] && echo "provide at least 2 arguments :(" && exit 1
faaDir=$1
fnaDir=$2
outDir=./output # default output directory
[ "$#" -eq 3 ] outDir=$3

[ -d $outDir ] && echo "$outDir dir already exists :(" && exit 1
mkdir $outDir
mkdir $outDir/mmseqs
faa=$outDir/conc_prots.faa
db=$outDir/mmseqs/db
dbcanHmm=$outDir/dbcan.hmmout
dbcanHotpep=$outDir/hotpep.out
chiTable=$outDir/chitinases.tsv

# concatenate all faa files
echo "concatenating input files"
sh src/001_concatenate_faa.sh $faaDir $faa

# create mmseqs database
echo "creating mmseqs database"
sh src/002_create_mmseqs_db.sh $faa $db >> $outDir/log

# run_dbcan hmm analysis
echo "detecting chitinases using hmm profiles"
sh src/003_dbcan_hmm.sh $faa $dbcanHmm data/dbcan

# run_dbcan hotpep analysis
echo "detecting conserved CAZy peptides"
sh src/004_dbcan_hotpep.sh $faa $dbcanHotpep >> $outDir/log

# process dbcan hmm and hotpep $outDirs to produce final chitinase table
echo "creating final chitinase table"
sh src/005_process_dbcan.R $dbcanHmm $dbcanHotpep $chiTable

# map user proteins to reference database
Rscript src/006_map_genomes.R \
  $outDir/mmseqs \
  $db \
  data/rep/rep \
  data/module_count.RData \
  $chiTable >> $outDir/log
