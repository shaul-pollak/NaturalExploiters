library(Matrix)
library(ggplot2)
library(data.table)
setDTthreads(0)
nphy <- function(x,lvl)
{
  f <- function(X,lvl)
  {
    nx <- neighboring[V1 == X, genome] 
    px <- phy[nx]
    return(length(unique(sapply(px,"[[",lvl))))
  }
  sapply(x,f,lvl=lvl)
}

# read non-redundant genomes table
gt <- fread("../output/gtdbtk/gtdbtk.bac120.summary.tsv")
gnms <- gsub("\\.fna$","",gt[[1]])
phy <- strsplit(gt[[2]],";")
phy <- lapply(phy,function(x) gsub("^.__","",x))
names(phy) <- gnms

# read filtered chitinase list
chi <- fread("../output/dbcan/filtered_output/chitinases_domtbl.txt")
setkey(chi,V1)
chi$genome <- gsub("_\\d+$","",chi$V1)
chi <- chi[chi$genome %in% gnms,]
idx <- chi[,.(genome,V1)]
idx$V1 <- regmatches(idx$V1,regexpr("\\d+$",idx$V1))
idx$V1 <- as.integer(idx$V1)
setkey(idx,genome)

# generate indices to extract
tokeep <- vector()
for (gnm in unique(idx$genome))
{
  message(gnm)
  chi_idx <- sort(idx[gnm,V1])
  close_genes <- lapply(chi_idx,function(x) max(1,(x-5)):(x+5))
  close_genes <- paste(gnm,Reduce(union,close_genes),sep="_")
  torem <- paste(gnm,chi_idx,sep="_")
  close_genes <- close_genes[!close_genes %in% torem]
  tokeep <- c(tokeep,close_genes)
}

# read gene to gene-family mapping
message("*** Loading gene map ***")
gene_map <- fread("../output/linclust/0.5.tsv",header=F)
invisible(gene_map[,genome := gsub("_\\d+$", "", V2)])
gene_map <- gene_map[genome %in% gnms,]
setkey(gene_map,V2)

# process neighboring genes
neighboring <- gene_map[tokeep,nomatch=NULL]
n2 <- gene_map[gene_map$V1 %in% unique(neighboring$V1),]
ui <- unique(n2$genome)
i <- match(neighboring$genome,ui)
uj <- unique(n2$V1)
j <- match(neighboring$V1,uj)
nm <- drop0(sparseMatrix(i=i,j=j,x=1,dims=c(length(ui),length(uj))))
dimnames(nm) <- list(ui,uj)
nm[nm>=1] <- 1 
i2 <- match(n2$genome,ui)
j2 <- match(n2$V1,uj)
nm2 <- drop0(sparseMatrix(i=i2,j=j2,x=1,dims=c(length(ui),length(uj))))
dimnames(nm2) <- list(ui,uj)
nm2[nm2>=1] <- 1 
p <- colSums(nm)/colSums(nm2)
N <- colSums(nm)
N_all <- colSums(nm2)
names(p) <- names(N) <- names(N_all) <- colnames(nm)
n <- data.table(gene=colnames(nm),N=N,N_all=N_all,p=p)
n <- n[order(-p),]
n[, ngenus := nphy(gene,6)]
n[, nfam := nphy(gene,5)]

# save
np <- n[p>=.1 & (ngenus > 1 | N >= 5),]
np <- np[order(-N),]
save(list="np",file="../output/proximity.RData")
np
