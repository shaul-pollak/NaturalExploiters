library(data.table)
setDTthreads(0)

args <- commandArgs(trailingOnly=T)
hmm_path <- args[1]
hotpep_path <- args[2]
out_path <- args[3]
ghs <- c("GH18","GH19")
ghs <- gsub("\\.hmm$","",ghs)

# process hotpep output
hotpep_raw <- fread(hotpep_path)
setkey(hotpep_raw,V1)
hotpep <- hotpep_raw[ghs,nomatch=NULL]

# process hmmer domain table
hmm_raw <- fread(cmd=sprintf('grep -v "^[#]" %s',hmm_path),header=T,fill=F)
colnames(hmm_raw) <- paste0("V",1:ncol(hmm_raw))
hmm_cov <- abs(hmm_raw$V17-hmm_raw$V16) / hmm_raw$V6
hmm <- hmm_raw[hmm_cov > .5 & 
               hmm_raw$V13 < 1e-10 & 
               hmm_raw$V4 %in% paste0(ghs,".hmm"),]
setkey(hmm,V1,V4)
hmm <- hmm[.(hotpep$V3,paste0(hotpep$V1,".hmm")),on=.(V1,V4),nomatch=NULL]
hmm$genome <- gsub("_\\d+$","",hmm$V1)
fwrite(hmm,file=out_path,sep="\t")
