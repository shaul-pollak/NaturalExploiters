# load libraries
library(phytools,quietly=T)
library(glmnet,quietly=T)
rm(list=ls())

args <- commandArgs(trailingOnly=T)
module_count_path <- args[1]
lm_path <- args[2]
iso_gtdbtk_path <- args[3]
mapping_path <- args[4]

load(mapping_path)
load(module_count_path)
load(lm_path)

#isolateMdlMat <- t(isolateMdlMat)
# read in isolate gtdbtk classification
iso_clsf <- read.table(iso_gtdbtk_path,sep='\t',header=T)
iso_phy <- regmatches(iso_clsf[,2],regexpr('p__[^;]+',iso_clsf[,2]))
iso_phy <- gsub('^p__','',iso_phy)
iso_cls <- regmatches(iso_clsf[,2],regexpr('c__[^;]+',iso_clsf[,2]))
iso_cls <- gsub('^c__','',iso_cls)
pro_idx <- iso_phy=='Proteobacteria'
iso_phy[pro_idx] <- iso_cls[pro_idx]
names(iso_phy) <- iso_clsf[,1]

# classify isolates
pr <- rep(0,length(isolateChi))
names(pr) <- names(isolateChi)
pr <- pr[names(pr) %in% rownames(isolateMdlMat)]
for(phy in unique(iso_phy)){
	message(phy)
	isoNms <- names(iso_phy)[iso_phy==phy]
	isoNms <- isoNms[isoNms %in% rownames(isolateMdlMat)]
	#phy <- "all"
  col.tokeep <- rownames(coef(rf_list[[phy]]))[-1]
	pr[isoNms] <- predict(rf_list[[phy]],
												isolateMdlMat[isoNms,col.tokeep,drop=F])
}
isoDF <- data.frame(obsChi=isolateChi,preChi=pr[names(isolateChi)],
                    class='',phy=iso_phy[names(isolateChi)])
rpred <- isoDF[,2]
rpt <- .5
isoDF$class[isoDF[,1]>=1 & rpred>=rpt] <- 'degrader'
isoDF$class[isoDF[,1]<1 & rpred<rpt] <- 'crossfeeder'
isoDF$class[isoDF[,1]<1 & rpred>=rpt] <- 'exploiter'
isoDF <- isoDF[order(rownames(isoDF)),]

table(isoDF[,3])

write.table(isoDF,
						file='../output/isolate_analysis/isolate_classification.tsv',
						sep="\t")
