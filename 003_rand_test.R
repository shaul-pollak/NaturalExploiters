require(Matrix, quietly = T)
require(phytools, quietly = T)
require(dqrng, quietly = T)
require(data.table, quietly = T)
require(castor, quietly = T)
require(parallel,quietly = T)
source("rand_test_functions.R")
setDTthreads(0)

anc_path <- "../output/anc.RData"
out_dir <- "../output/rand_test"
chit_count_path <- "../output/chit_anc.RData"
cnt <- 1
stepsize <- 5
ncore <- parallel::detectCores()
pen <- 0

argin <- commandArgs(trailingOnly = TRUE)
if(length(argin)>1)
{
  cat(sprintf("\t*** argin length = %s ***\n", length(argin)))
  cnt <- as.numeric(argin[1])
  anc_path <- argin[2]
  chit_count_path <- argin[3]
  out_dir <- argin[4]
  stepsize <- as.numeric(argin[5])
  if(length(argin)>5){ pen <- as.numeric(argin[6]) }
}
if(!dir.exists(out_dir)) dir.create(out_dir)

# load
message("loading anc")
load(anc_path)
message("loading chit anc")
load(chit_count_path)

# isolate genome size
gs <- anc[,"gensize"] 

# remove PFs that contain chitinases
anc <- anc[, !(colnames(anc) %in% c("gensize", chi_genes))] 

# calculate change.mat
change.mat <- anc[tre$edge[,1],] - anc[tre$edge[,2],]

# filter based on number of changes
minchange <- 3
min_gens <- 5
tokeep <- colSums(change.mat != 0) > minchange
tokeep <- tokeep[names(tokeep) %in% colnames(anc)]
# make sure that PFs are found in at least $(min_gens) genomes
tokeep <- tokeep & colSums(anc[1:Ntip(tre), ] != 0) > min_gens
anc <- anc[, tokeep]
change.mat <- change.mat[, colnames(anc)]

# reorder edge list in reverse postorder,
# so that nodes near the root come first
elist <- reorder(tre, "postorder")$edge
elist <- elist[nrow(elist):1, ]
nl <- Ntip(tre)

# for each gene, get relevant nodes, compute p-value distributions for both row
# and column permutations
indx <- ((cnt - 1) * stepsize + 1):(cnt * stepsize)
if (indx[1] > ncol(anc)) stop("you went too far shaul, TOO FAR!")
if (indx[1] <= ncol(anc) & indx[length(indx)] > ncol(anc)) {
  indx <- indx[1]:ncol(anc)
}

# loop
tmp <- lapply(seq_len(length(indx)),FUN=loop_f,penalty=pen,gainloss=F)
pcors <- sapply(tmp, function(x) x[[1]])
pvs.randomization <- sapply(tmp, function(x) x[[2]])
names(pcors) <- names(pvs.randomization) <- colnames(anc)[indx]

# save
save(list = c("pcors", "pvs.randomization"),
  file = sprintf("%s/rand_%s.RData", out_dir, cnt))
