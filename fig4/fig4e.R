rm(list=ls())
library(openxlsx)
library(svglite)
library(phytools)
library(ggplot2)
library(latex2exp)
library(RColorBrewer)
library(ggtree)
source("functions.R")
load("data/fig4.RData")

####
# plot
####

## bar plots
o <- order(clsf[,3],rownames(clsf))
rns <- df[,1]
d <- df[,-1]
d[d<1e-3] <- 0
dl <- lapply(d,norm_class,rns=rns,clsf=clsf)
d <- cbind(df$X,as.data.frame(do.call(cbind,dl)))
colnames(d)[1] <- "strain"
d <- tidyr::pivot_longer(d,-1)
d <- d[grepl("C2|T0",d$name),]
d$time <- get_time(d$name)
d$rep <- get_rpt(d$name)
d$rep[d$time==0] <- 1
d$dilution <- get_dil(d$name)
d <- d[,-2]
d$x <- (d$dilution-1)*4+d$rep
d$x[d$x>4] <- d$x[d$x>4]+1
d$x[d$x>9] <- d$x[d$x>9]+1
d$clsf <- clsf[as.character(d$strain),3]
# create color palette
strns <- unique(as.character(d$strain[d$value>0 & d$time>9]))
sc <- rep("grey99",length(unique(d$strain)))
names(sc) <- unique(d$strain)
sord <- vector()
for(cls in names(clr))
{
  n1 <- unique(d$strain[d$clsf==cls])
  n2 <- n1[!(n1 %in% strns)]
  ns <- strns[clsf[strns,3]==cls]
  sord <- c(sord,n2,ns)
  c1 <- "grey80"
  if(cls=="degrader") c1 <- "khaki1"
  if(cls=="exploiter") c1 <- "skyblue"
  plt <- colorRampPalette(c(c1,clr[cls]))(length(ns))
  sc[ns] <- plt
}
d$strain <- factor(d$strain,levels=sord)
theme_set(theme_minimal(base_size=10))
i <- max(d$time)
tplt <- d[d$time==i & d$value>0,]
for(cls in unique(tplt$clsf))
{
  torem <- as.character(unique(tplt$strain[!(tplt$strain %in% strns) & tplt$clsf==cls]))
  tokeep <- torem[1]
  torem <- setdiff(torem,tokeep)
  tplt$strain[tplt$strain %in% torem] <- tokeep 
}
p <- ggplot(tplt,aes(x,value,fill=strain)) + 
  geom_col(col="grey90",size=.2) +
  scale_x_continuous(breaks=unique(d$x)) +
  labs(x = NULL, y = "Freq.") +
  theme(legend.key.size=unit(2,"mm")) +
  scale_fill_manual(values=sc) +
  guides(fill = guide_legend(ncol = 1))
ggsave(plot=p,file="fig4e.svg",width=3.0,height=3.719)
##
