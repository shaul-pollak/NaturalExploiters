require(glmnet)
require(phytools)
require(Matrix)
require(svglite)
require(latex2exp)
rm(list=ls())

# set default parameters
module_count_path <- "../output/module_count.RData"
gtdbtk_tsv_path <- "../output/gtdbtk/gtdbtk.bac120.summary.tsv"
out_path <- "../output/l1_lm.RData"
subsamp <- F

# process command line
arg <- commandArgs(trailingOnly = T)
if(length(arg)>1)
{
  module_count_path <- arg[1]
  gtdbtk_tsv_path <- arg[2]
  out_path <- arg[3]
}

# load data
load(module_count_path)

# read gtdbtk tsv
gtdbtk_table <- read.table(gtdbtk_tsv_path, sep = "\t", header = T)
gtdbtk_table[, 1] <- gsub("[.]fna$", "", gtdbtk_table[, 1])

# extract phylum
phy <- regmatches(gtdbtk_table[, 2], regexpr("p__[^;]+", gtdbtk_table[, 2]))
phy <- gsub("^p__", "", phy)
phy <- gsub("_.+$", "", phy) # unite all split firmicutes
names(phy) <- gtdbtk_table[, 1]

# extract class
cl <- regmatches(gtdbtk_table[, 2], regexpr("c__[^;]+", gtdbtk_table[, 2]))
cl <- gsub("^c__", "", cl)
phy[phy == "Proteobacteria"] <- cl[phy == "Proteobacteria"]
phy_table <- sort(table(phy), decreasing = T)
phy[(phy %in% names(phy_table)[phy_table <= 100])] <- "other"
phy_table <- sort(table(phy), decreasing = T)

# train random forest classifier for everything and for each phylum
clr <- ggsci::pal_aaas()(10)
names(clr) <- sort(unique(phy))
rf_list <- list()
for (phylum in c("all",names(phy_table))) {
  cat(sprintf("phylum = %s\n",phylum))
  if (phylum == "all") {
    nms <- names(phy)
    idx <- colnames(mdl_mat) %in% nms
    idx2 <- rowSums(mdl_mat[, idx] != 0) > 0
  } else {
    nms <- names(phy)[phy == phylum]
    idx <- colnames(mdl_mat) %in% nms
    idx2 <- rowSums(mdl_mat[, idx] != 0) > 0
  }
  tmat <- t(as.matrix(mdl_mat[idx2, idx]))
  dup <- duplicated(tmat)
  tmat2 <- tmat[!dup,]
  if(subsamp)
  {
    i1 <- tmat2[,"chitinase"]>0
    if(sum(i1) >= 1)
    {
      i2 <- tmat2[,"chitinase"]==0
      si1 <- ceiling(sum(i1))
      si2 <- ceiling(sum(i2))
      if(sum(i2)>si1)
      {
        i1 <- which(i1)
        i2 <- sample(which(i2),max(10,si1))
      } else if(sum(i1)>si2)
      {
        i2 <- which(i2)
        i1 <- sample(which(i1),max(10,si2))
      }
      tred <- tmat2[,colnames(tmat2)!="chitinase"]
      j1 <- colSums(tred[i1,])
      j2 <- colSums(tred[i2,])
      cs <- c(which(j1 > 0 & j2 > 0))
      #cs <- 1:ncol(tmat2)
      tmat2 <- tmat2[union(i1,i2),cs]
    }
  } else
  {
    tmat2 <- tmat2[, colnames(tmat2) != "chitinase"]
  }
  lm <- cv.glmnet(tmat2,chi[rownames(tmat2)],
                  nfold=5,alpha=0.2,nlambda=1e3) 
  rf_list[[phylum]] <- lm
  # predict values and get important modules
  pre <- predict(lm, newx=tmat[,rownames(coef(lm))[-1]],s="lambda.min")
}

# save
save(list = "rf_list", file = out_path)
