###
# this script converts raw fluorescence reads from the platereader into R
# compatible matrices and then plots the scatterplot seen in figure 2A
###

rm(list=ls())
library(readxl)
library(ggplot2)
f <- new.env()
f$raw_read <- function(path)
{
  d <- suppressMessages(read_excel(path))
  nr <- which(grepl("name", d[[1]], ignore.case=T))[2]
  name <- d[[2]][nr]
  drs <- which(grepl("<>",d[[1]]))+1
  dre <- drs+7
  out <- d[drs:dre,2:13]
  out <- sapply(1:ncol(out),function(j) out[[j]] <- as.numeric(out[[j]]))
  out <- list(data=out)
  names(out) <- name
  return(out)
}
f$layout_read <- function(path,dict_path)
{
  strain_dict <- read.table(dict_path,header=T)
  inp <- read_excel(path, col_names = F, .name_repair="minimal")
  out <- suppressWarnings(sapply(1:ncol(inp),function(x) as.numeric(inp[[x]])))
  out <- matrix(strain_dict[out,4],nrow=nrow(out),ncol=ncol(out))
  out[is.na(out)] <- inp[is.na(out)]
  return(out)
}
f$agg <- function(d,l)
{
  aggregate(as.vector(d),by=list(as.vector(l)),mean)
}
f$rem_blank_and_t0 <- function(desc,raw,layout,ltype=NULL)
{
  if(is.null(ltype))
  {
    blank_i <- grepl("blank",layout,ignore.case=T)
    blank_mean <- lapply(raw,function(x) mean(x[blank_i]))
    rmb <- lapply(1:length(raw),function(i) raw[[i]]-blank_mean[[i]])
    names(rmb) <- names(raw)
    tps <- unique(desc$type)
    out <- list()
    for(tp in tps)
    {
      i <- which(desc$type==tp)
      i0 <- which(desc$type==tp & desc$time==0)
      tmp <- lapply(rmb[i],function(x) x - rmb[[i0]])
      agg <- lapply(tmp,function(x,l) data.frame(strain=as.vector(l),fluo=as.numeric(as.vector(x))),l=layout)
      tms <-  desc$time[i]
      for(I in 1:length(tms))
      {
        agg[[I]] <- cbind(agg[[I]],data.frame(time=rep(tms[I],nrow(agg[[I]])),rep=getrep(agg[[I]])))
      }
      out[[tp]] <- do.call(rbind,agg)
      rownames(out[[tp]]) <- NULL
      out[[tp]]$tp <- tp
    }
  }
  else
  {
    tps <- unique(desc$type)
    out <- list()
    for(tp in tps)
    {
      i <- which(desc$type==tp)
      i0 <- which(desc$type==tp & desc$time==0)
      lout <- layout[unlist(ltype)==tp]
      rmb <- lapply(raw[i],function(x) x-mean(x[grepl("blank",lout,ignore.case=T)]))
      tmp <- lapply(rmb,function(x) x - rmb[[which(i==i0)]])
      agg <- lapply(tmp,function(x,l) data.frame(strain=l,fluo=as.numeric(x)),l=lout)
      tms <-  desc$time[i]
      for(I in 1:length(tms))
      {
        agg[[I]] <- cbind(agg[[I]],data.frame(time=rep(tms[I],nrow(agg[[I]])),rep=getrep(agg[[I]])))
      }
      out[[tp]] <- do.call(rbind,agg)
      rownames(out[[tp]]) <- NULL
      out[[tp]]$tp <- tp
    }
  }
  out <- do.call(rbind,out)
  rownames(out) <- NULL
  return(out)
}
f$split_plate <- function(raw,ltype)
{
  out <- list()
  for(i in 1:length(raw))
  {
    x <- raw[[i]]
    cats <- unique(unlist(ltype))
    out[[i]] <- list() 
    for(cat in cats)
    {
      out[[i]][[cat]] <- raw[[i]][ltype==cat] 
    }
  }
  out2 <- unlist(out,recursive=F,use.names=F)
  names(out2) <- paste(rep(names(raw),each=length(cats)),cats,sep=" ")
  nsplt <- strsplit(names(out2)," ")
  desc <- data.frame(name=names(out2))
  desc$exp_date <- sapply(nsplt,"[[",1)
  desc$time <- as.numeric(gsub("^t","",sapply(nsplt,"[[",2)))
  desc$type <- sapply(nsplt,"[[",3)
  return(list(desc=desc,raw=out2))
}
VEC <- function(x)
{
  as.vector(unlist(x))
}
getrep <- function(x)
{
  ux <- unique(x[[1]])
  cnts <- rep(0,length(ux))
  names(cnts) <- ux
  out <- rep(0,nrow(x))
  for (i in 1:nrow(x))
  {
    cnts[x[i,1]] <- cnts[x[i,1]]+1
    out[i] <- cnts[x[i,1]]
  }
  return(out)
}
rem_noc <- function(x)
{
  nc <- startsWith(x$tp,"no") | startsWith(x$tp,"No")
  noc <- x[nc,]
  tps <- unique(x[!nc,"tp"])
  out <- list()
  for (tp in tps)
  {
    xi <- x[x$tp==tp,]
    nocav <- aggregate(noc$fluo,by=list(strain=noc$strain,time=noc$time),FUN=mean)
    nocav$x <- sapply(nocav$x,function(Y) max(0,Y))
    for (i in 1:nrow(xi))
    {
      idx <- (nocav$strain == xi$strain[i]) & (nocav$time == xi$time[i])
      xi[i,"fluo"] <- xi[i,"fluo"] - 2*nocav[idx,"x"]
    }
    out[[tp]] <- xi
  }
  out <- do.call(rbind,out)
  rownames(out) <- NULL
  return(out)
}

dictpath <- "strain_dict.tsv"

############
# sep8
############
files <- dir("data/august-september2020/sep8","SYBR")
paths <- paste0("data/august-september2020/sep8/",files)
raw <- lapply(paths,f$raw_read)
names(raw) <- sapply(raw,names)
raw <- lapply(raw,function(x) x[[1]])
layout <- f$layout_read("data/august-september2020/layouts/9_8_layout.xlsx",dictpath)
ltype <- read_excel("data/august-september2020/layouts/9_8_type.xlsx",
                    .name_repair="minimal",
                    col_names = F)
l <- f$split_plate(raw,ltype)
desc <- l[[1]]
desc$type[grepl("no",desc$type)] <- unlist(ltype)[grepl("no",unlist(ltype))][1]
raw <- l[[2]]
agg <- f$rem_blank_and_t0(desc,raw,layout,ltype)
sep8 <- agg
sep8$date <- "sep8"
strns <- list(sep8=unique(sep8$strain))

############
# aug31
############
# read data
files <- dir("data/august-september2020/aug31","SYBR")
paths <- paste0("data/august-september2020/aug31/",files)
raw <- lapply(paths,f$raw_read)
names(raw) <- sapply(raw,names)
raw <- lapply(raw,function(x) x[[1]])
nsplt <- strsplit(names(raw)," ")
desc <- data.frame(name=names(raw))
desc$exp_date <- sapply(nsplt,"[[",1)
desc$time <- as.numeric(gsub("^t","",sapply(nsplt,"[[",2)))
desc$time[desc$time==140] <- 144 # im stupid
desc$type <- sapply(nsplt,"[[",3)
rm(nsplt,files,paths)
# read layouts
path <- "data/august-september2020/layouts/8_31_layout.xlsx"
layout <- f$layout_read(path,dictpath)
rm(path)
noC_t0 <- aggregate(as.vector(raw[[3]]),by=list(as.vector(layout)),mean)
tokeep <- noC_t0$x > 1.5*noC_t0$x[noC_t0[,1]=="blank"]
agg <- f$rem_blank_and_t0(desc,raw,layout)
aug31 <- agg
aug31$date <- "aug31"
strns$aug31 <- unique(aug31$strain)
tkp <- setdiff(strns$aug31,Reduce(union,strns[-length(strns)]))
aug31 <- aug31[aug31$strain %in% tkp,]

############
# aug11
############
files <- dir("data/august-september2020/aug11","SYBR")
paths <- paste0("data/august-september2020/aug11/",files)
raw <- lapply(paths,f$raw_read)
names(raw) <- sapply(raw,names)
raw <- lapply(raw,function(x) x[[1]])
layout <- f$layout_read("data/august-september2020/layouts/8_11_layout.xlsx",dictpath)
ltype <- read_excel("data/august-september2020/layouts/8_11_type.xlsx",
                    .name_repair="minimal",
                    col_names = F)
l <- f$split_plate(raw,ltype)
desc <- l[[1]]
desc$type[grepl("no",desc$type)] <- unlist(ltype)[grepl("no",unlist(ltype))][1]
raw <- l[[2]]
rm(files,paths,l)
agg <- f$rem_blank_and_t0(desc,raw,layout,ltype)
aug11 <- agg
aug11$date <- "aug11"
strns$aug11 <- unique(aug11$strain)
tkp <- setdiff(strns$aug11,Reduce(union,strns[-length(strns)]))
aug11 <- aug11[aug11$strain %in% tkp,]



############
# aug10
############
files <- dir("data/august-september2020/aug10","SYBR")
paths <- paste0("data/august-september2020/aug10/",files)
raw <- lapply(paths,f$raw_read)
names(raw) <- sapply(raw,names)
raw <- lapply(raw,function(x) x[[1]])
layout <- f$layout_read("data/august-september2020/layouts/8_10_layout.xlsx",dictpath)
ltype <- read_excel("data/august-september2020/layouts/8_10_type.xlsx",
                    .name_repair="minimal",
                    col_names = F)
l <- f$split_plate(raw,ltype)
desc <- l[[1]]
desc$type[grepl("no",desc$type)] <- unlist(ltype)[grepl("no",unlist(ltype))][1]
raw <- l[[2]]
rm(files,paths,l)
agg <- f$rem_blank_and_t0(desc,raw,layout,ltype)
aug10 <- agg
aug10$date <- "aug10"
strns$aug10 <- unique(aug10$strain)
tkp <- setdiff(strns$aug10,Reduce(union,strns[-length(strns)]))
aug10 <- aug10[aug10$strain %in% tkp,]

# combine
fluo <- rbind(aug10,aug11,aug31,sep8)

################
# older data
################
# read layouts
layout_files <- paste0("data/july-august2020/layout/",
                       dir("data/july-august2020/layout","*.xlsx"))
layouts <- lapply(layout_files,read_excel,col_names=F,.name_repair="minimal")
names(layouts) <- gsub("^layout_|\\.20|\\.xlsx$","",basename(layout_files))
# read plate reader data
files <- paste0("data/july-august2020/",
                dir("data/july-august2020","SYBR"))
raw <- lapply(files,f$raw_read) 
names(raw) <- sapply(raw,names)
raw <- lapply(raw,function(x) x[[1]])
nsplt <- strsplit(names(raw)," ")
desc <- data.frame(name=names(raw))
desc$exp_date <- sapply(nsplt,"[[",1)
desc$time <- as.numeric(gsub("^t|[hH]$","",sapply(nsplt,"[[",2)))
desc$type <- sapply(nsplt,"[[",3)
rm(nsplt)
desc$type[desc$type=="no"] <- "no C"
agg1 <- f$rem_blank_and_t0(desc[desc$exp_date=="7.21",],raw[desc$exp_date=="7.21"],as.matrix(layouts[[1]]))
agg1$date <- "july21"
agg2 <- f$rem_blank_and_t0(desc[desc$exp_date=="7.22",],raw[desc$exp_date=="7.22"],as.matrix(layouts[[2]]))
agg2$date <- "july22"
agg <- rbind(agg1,agg2)
rownames(agg) <- NULL
strain_dict <- read.table(dictpath,header=T)
old <- agg
old[1][old[1]!="blank"] <- strain_dict[old[1][old[1]!="blank"],4]
strns$old <- unique(old$strain)
tkp <- setdiff(strns$old,Reduce(union,strns[-length(strns)]))
old <- old[old$strain %in% tkp,]

fl <- rbind(fluo,old)
rownames(fl) <- NULL
fl$tp[grepl("^no",fl$tp)] <- "no C"
fl <- fl[fl$time <= 96,]
noc <- fl[fl$tp=="no C",]
tosub <- aggregate(noc$fluo,by=list(strain=noc$strain,rep=noc$rep),max)
tosub <- aggregate(tosub$x,by=list(strain=tosub$strain),mean)
fl$fluo <- fl$fluo - 2*tosub$x[match(fl$strain,tosub$strain)]
fl$fluo <- sapply(fl$fluo,function(x) max(0,x))
fl <- fl[fl$tp!="no C",]
fl$grp <- factor(paste0(fl$date,fl$rep,fl$tp))

clsf <- read.table("isolate_classification.tsv")
clsf[clsf[,1] > 0 & clsf[,2] > .5,3] <- "degrader"
clsf[clsf[,1] == 0 & clsf[,2] > .5,3] <- "exploiter"
clsf[clsf[,2] <= .5,3] <- "scavenger"

mx <- aggregate(fl$fluo,by=list(strain=fl$strain,rep=fl$rep,type=fl$tp),max)
mx2 <- aggregate(mx$x,by=list(strain=mx$strain,type=mx$type),mean)
mx3 <- tidyr::pivot_wider(mx2, names_from = type, values_from = x)
mx3 <- mx3[mx3$strain %in% rownames(clsf),]
mx3$clsf <- clsf[mx3$strain,3]
mx3$pheno <- ""
mx3$pheno[mx3$glcnac>=1e3 & mx3$chitin>=1e3] <- "Degrader"
mx3$pheno[mx3$glcnac>=1e3 & mx3$chitin<=1e3] <- "Exploiter"
mx3$pheno[mx3$glcnac<=1e3 & mx3$chitin<=1e3] <- "Scavenger"
clr <- c(Degrader="#ddaa33ff",Exploiter="#007effff",Scavenger="black")

fig2a <- ggplot(mx3,aes(jitter(glcnac+1,amount=.5),jitter(chitin+1,amount=.5),color=pheno)) + 
  geom_hline(yintercept=1000) +
  geom_vline(xintercept=1000) +
  geom_point(shape=1,size=2) + 
  scale_x_log10() + 
  scale_y_log10() +
  scale_color_manual(values=clr) +
  theme_shaul()+
  theme(legend.position="none",
        axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.text.x=element_blank(),
        plot.margin=grid::unit(c(0,0,0,0), "mm")) 
ggsave("Fig2A.svg",fig2a,width=1.169,height=1.108,units="in")

save(list=c("fl","mx3"),file="fluo_all3.RData")
