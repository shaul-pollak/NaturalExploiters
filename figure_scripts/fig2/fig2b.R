###
# this script takes the output of the fig2a.R script (fluo_all3.RData) and the
# output of the CarveMe generated Genome-scale metabolic models (fluxOnAcgam.csv), 
# and calculates how well each model predicts exploiters in gamma-proteobacteria
# and flavobacteria.
# 
# this data is presented in figure 2B
###

rm(list=ls())
library(ggplot2)
load("fluo_all3.RData")

clr <- c(degrader="#ddaa33ff",exploiter="#007effff",scavenger="black")
#d <- as.data.frame(fluo[,-1] - 2*fluo[,1])
d <- as.data.frame(mx3[,3:2])
rownames(d) <- mx3$strain
d[d<0] <- 0
clsf <- read.table("isolate_classification.tsv")
clsf[clsf[,1]>0 & clsf[,2]>=.5,3] <- "degrader"
clsf[clsf[,1]==0 & clsf[,2]>=.5,3] <- "exploiter"
clsf[clsf[,2]<.5,3] <- "scavenger"
d$clsf <- clsf[rownames(d),3]
d2 <- d

# fba
fba <- read.table("data/fluxOnAcgam.csv")
rownames(fba) <- fba[,1]
fba <- fba[,-1,drop=F]
fba$chitinase <- clsf[rownames(fba),1]>0
fba$clsf <- "scavenger"
fba$clsf[fba[,1]>0 & fba[,2]] <- "degrader"
fba$clsf[fba[,1]==0 & fba[,2]] <- "scavenger"
fba$clsf[fba[,1]>0 & !fba[,2]] <- "exploiter"

###
d3 <- d2
d3$clsf <- fba[rownames(d3),3]
d3$clsf2 <- d2$clsf
b1 <- aggregate(d3$glcnac,by=list(clsf=d3$clsf),function (x) sum(x>1000)/length(x))
b2 <- aggregate(d3$chitin,by=list(clsf=d3$clsf),function (x) sum(x>1000)/length(x))
b <- cbind(b1,b2[,2])
colnames(b) <- c("clsf","GlcNAc","Chitin")
b2 <- tidyr::gather(b,"C-source","Perc-Growth",GlcNAc:Chitin)
# phenotype clustering
haschi <- rownames(clsf)[clsf$obsChi>0]
d3$clsf3 <- ""
d3$clsf3[d3$glcnac>1000 & d3$chitin>1000] <- "degrader"
d3$clsf3[d3$glcnac>1000 & d3$chitin<1000] <- "exploiter"
d3$clsf3[d3$glcnac<=1000 & d3$chitin<=1000] <- "scavenger"
gtdb <- read.table("data/gtdbtk.bac120.summary.tsv",sep="\t",header=T)
gtphy <- strsplit(gtdb[[2]],";")
names(gtphy) <- gtdb[[1]]
pheno <- d3
colnames(pheno)[3:5] <- c("fba","coevo","phenotype")
pheno$coevo <- clsf[rownames(pheno),3]
pheno$phy <- sapply(gtphy[rownames(pheno)],function(x) gsub("^c__","",x[3]))
pheno$id <- rownames(pheno)

tplt <- data.frame()
for(role in c("degrader","exploiter","scavenger"))
{
  for(phy in setdiff(unique(pheno$phy),"Alphaproteobacteria"))
  {
    tmp <- pheno[pheno$phy==phy,]
    tot <- sum(tmp$phenotype==role)
    if(tot==0) next
    ffba <- sum(tmp$fba==role & tmp$phenotype==role)
    fcoevo <- sum(tmp$coevo==role & tmp$phenotype==role)
    tdf <- data.frame(phy=phy,model=c("fba","coevo"),success_prob=c(ffba/tot,fcoevo/tot),type=role,n=sum(tmp$phenotype==role))
    tplt <- rbind(tplt,tdf)
  }
}

tplt$phy[grepl("Gamma",tplt$phy)] <- "Î³-Proteo."
tplt$phy[grepl("Bact",tplt$phy)] <- "Bactero."
clrs <- c("#7d26cdff","#f3d8c7ff")
p2 <- ggplot(tplt[tplt$type=="exploiter",],aes(x=phy,y=success_prob,fill=model)) +
  geom_col(position="dodge",col="black") +
  scale_fill_manual(values=clrs) +
  labs(x="Phylogenetic class",y="# of successful predictions") +
  theme_shaul(x.label.rotation=90,base_size=8,base_family="Arial") +
  theme(legend.position="none")
totwidth=109.605
ggsave("fig2b.svg",p2,width=totwidth/4,height=37.460,units="mm")
