rm(list=ls())
require(openxlsx)
require(Matrix)
require(svglite)
require(latex2exp)
require(ggplot2)
require(patchwork)
require(outliers)
require(zoo)
get_rep <- function(x) gsub("^M|\\..+$","",x)
get_time <- function(x) as.integer(gsub("^.+T","",x,perl=T))
trans_nms <- function(x)
{
  M <- 1:3 
  names(M) <- LETTERS[1:3]
  rpt <- M[gsub("^.+_","",x,perl=T)]
  tm <- as.integer(gsub("Beads_Chitin_|_[^_]+$","",x,perl=T))
  sprintf("M%s.T%s",rpt,tm)
}
prepare_toplot <- function(x)
{
  tdf <- tidyr::pivot_longer(x,-1)
  tdf$time <- get_time(tdf$name)
  tdf$rep <- get_rep(tdf$name)
  tdf <- tidyr::pivot_wider(tdf[,-2],names_from=time,values_from=value)
  tdf <- tdf[apply(tdf[,-(1:2)],1,max)>1e-3,]
  tdf2 <- tidyr::pivot_longer(tdf,-(1:2))
  tdf2$time <- as.integer(tdf2$name)
  tdf2$type <- isoDF[tdf2$X,3]
  tdf2$grp <- paste0(tdf2$X,tdf2$rep)
  return(tdf2)
}

isoDF <- read.table("../fig2/isolate_classification.tsv")
chitinases <- isoDF$obsChi
names(chitinases) <- rownames(isoDF)
minfreq <- 1e-3

# get names of isolates to process
iso.names <- rownames(isoDF)

# get files to process
files <- dir("data",full.names=T)

##########################
## process Manoshi's data
##########################
mESV <- read.xlsx("data/manoshi_otuToStrain.xlsx")
mESV <- mESV[mESV[, 1] %in% names(chitinases), ]
mCount <- read.table("data/manoshi_count.txt", sep = "\t", header = T)
nmat <- matrix(0, nrow = (ncol(mCount) - 1), ncol = (ncol(mCount) - 1))
diag(nmat) <- 1 / colSums(mCount[, -1])
mCount[, -1] <- as.matrix(mCount[, -1]) %*% nmat
mCount <- mCount[mCount$OTUId %in% mESV$OTU[!is.na(mESV$OTU)], ]
colsTokeep <- grepl("^OTU|^M", colnames(mCount))
mCount <- mCount[, colsTokeep]
rownames(mCount) <- mESV$Strain[match(mCount$OTUId, mESV$OTU)]
names(mCount)[1] <- "X"
mCount$X <- rownames(mCount)

##########################
## process Tim's data
##########################
tESV2 <- read.delim(files[grepl("16s.+[.]tsv", files)])
tESV2 <- tESV2[tESV2$pident >= 100, ]
tESV2 <- data.frame(Strain = trimws(tESV2$sseqid), ESV = tESV2$qseqid, pident = tESV2$pident)
tESV <- tESV2
tESV <- tESV[tESV$Strain %in% names(chitinases), ]
tCount <- read.csv(files[grepl("tim.*count", files)])
tCount[-1] <- Map(as.numeric, tCount[-1])
# only keep chitin bead data
tCount <- tCount[grepl("X|Beads.*Chitin", names(tCount))]
tCount[-1] <- Map(function(x) x / sum(x), tCount[-1])
tmp <- tCount[1, ]
tmp <- tmp[-1, ]
# combine ESVs that match isolate 16S
for (id in unique(tESV$Strain)) {
  esvs <- tESV$ESV[tESV$Strain == id]
  ri <- tCount$X %in% esvs
  freqs <- colSums(tCount[ri, -1])
  tmp <- rbind(tmp, c(id, freqs))
}
tmp[-1] <- Map(as.numeric, tmp[-1])
colnames(tmp) <- colnames(tCount)
tCount <- tmp
rownames(tCount) <- tCount$X
# remove hits to strains found in manoshi's experiment
tCount <- tCount[setdiff(rownames(tCount),rownames(mCount)),] 
tCount <- tCount[apply(tCount,1,max)>1e-3,]
names(tCount)[-1] <- trans_nms(names(tCount)[-1])


tdf1 <- prepare_toplot(mCount)
tdf2 <- prepare_toplot(tCount)
tdf <- rbind(tdf1,tdf2)
tdf <- tdf[tdf$time<=150,]
tdf$type[tdf$type=="scavenger"] <- "Scav."
tdf$type[tdf$type=="degrader"] <- "Deg."
tdf$type[tdf$type=="exploiter"] <- "Exp."

tkp <- c("1A01","4B03","6D02")
tkp <- tdf[tdf$X %in% tkp,]

p <- ggplot(tdf,aes(time,value,group=grp,col=type)) + 
  geom_line(color="lightgrey") + 
  geom_line(data=tkp) + 
  geom_vline(xintercept=48) +
  theme_shaul(base_size=8) + 
  facet_grid(rows=vars(type),scales="free") + 
  scale_color_manual(values=adjustcolor(c("gold3","skyblue","black"),
                                        alpha.f=1)) +
  theme(legend.position="none") +
  labs(y = "Rel. freq.",x="Time [h]")
ggsave("fig3b.svg",p,h=1.55,w=1.5)
