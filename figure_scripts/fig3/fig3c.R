require(openxlsx)
require(Matrix)
require(svglite)
require(latex2exp)
require(ggplot2)
require(patchwork)
require(outliers)
require(zoo)
rm(list=ls())
ave_slope <- function(x,rpt,times,rns,manoshi=F,minfreq = 1e-4)
{
  x2 <- unlist(x)[-1]
  df <- data.frame(x=x2,rpt=rpt,t=times)
  df2 <- as.data.frame(t(tidyr::pivot_wider(df,names_from=t,values_from=x))[-1,])
  for(i in 1:ncol(df2)) df2[,i] <- as.numeric(df2[,i])
  df2[df2<minfreq] <- NA
  o <- order(as.integer(rownames(df2)))
  #df3 <- apply(df2[o,],2,rollmean,2,align="left")
  df4 <- df2[o,]
  df4r <- as.integer(rownames(df4))
  i <- df4r < 60 & df4r!=0
  if(manoshi) i <- df4r < 50 & df4r!=0
  co <- cor(df4[1:max(which(i)),],use="pairwise.complete.obs")
  co <- co[upper.tri(co)]
  coi <- which(co>.3)
  if (length(coi)==1) 
  {
    com <- matrix(c(1,2,1,3,2,3),nrow=3,ncol=2,byrow=T)
    df4 <- df4[,com[coi,]]
  } else if (length(coi)==0) 
  {
    return(c(slp=NA,maxfreq=NA,numnonsezo=NA,cor=NA))
  } else if (length(coi)==2)
  {
    ci <- which.max(co)
    com <- matrix(c(1,2,1,3,2,3),nrow=3,ncol=2,byrow=T)
    df4 <- df4[,com[ci,]]
  }
  tm <- apply(df4[i,],2,function(x) which(x==max(x,na.rm=T)))
  x0 <- unlist(df4[1,])
  x1 <- df4[-1,][cbind(tm,1:ncol(df4))]
  s <- x1-x0
  slp <- s / as.integer(rownames(df4))[tm+1]
  if(0==1)
  {
    x11(h=3,w=3)
    df5 <- tidyr::pivot_longer(as.data.frame(df4),V1:V3)
    df5$time <- rep(as.integer(rownames(df4)),each=ncol(df4))
    p <- ggplot(df5,aes(time,value,col=name)) + 
      geom_line(aes(group=name)) + 
      geom_point(size=3) + 
      theme_shaul() + 
      ggtitle(rns[x[1]])
    print(p)
  }
  co <- cor(df4[1:max(which(i)),],use="pairwise.complete.obs")
  co <- co[upper.tri(co)]
  co <- if(length(co)>1) mean(co) else co
  df4 <- df4[1:max(which(i)),]
  return(c(slp=mean(slp,na.rm=T),maxfreq=mean(apply(df4,2,max,na.rm=T)),numnonsezo=sum(df4!=0,na.rm=T),cor=co))
}

isoDF <- read.table("../fig2/isolate_classification.tsv")
modules <- isoDF$preChi
chitinases <- isoDF$obsChi
names(modules) <- names(chitinases) <- rownames(isoDF)
minfreq <- 1e-3

# get names of isolates to process
iso.names <- rownames(isoDF)

# get files to process
files <- dir("data",full.names=T)

##########################
## process Manoshi's data
##########################
mESV <- read.xlsx("data/manoshi_otuToStrain.xlsx")
mESV <- mESV[mESV[, 1] %in% names(modules), ]
mCount <- read.table("data/manoshi_count.txt", sep = "\t", header = T)
nmat <- matrix(0, nrow = (ncol(mCount) - 1), ncol = (ncol(mCount) - 1))
diag(nmat) <- 1 / colSums(mCount[, -1])
mCount[, -1] <- as.matrix(mCount[, -1]) %*% nmat
mCount <- mCount[mCount$OTUId %in% mESV$OTU[!is.na(mESV$OTU)], ]
colsTokeep <- grepl("^OTU|^M", colnames(mCount))
mCount <- mCount[, colsTokeep]
rownames(mCount) <- mESV$Strain[match(mCount$OTUId, mESV$OTU)]
times <- gsub("^M.+T", "", colnames(mCount[, -1]))
times <- as.integer(times)
rpt <- gsub("\\..+$","",colnames(mCount)[-1])
rns <- rownames(mCount)
names(rns) <- mCount[,1]
mslp <- t(apply(mCount,1,ave_slope,rpt,times,rns,T))
mslp <- mslp[!is.na(mslp[,1]),]

##########################
## process Tim's data
##########################
tESV2 <- read.delim(files[grepl("16s.+[.]tsv", files)])
tESV2 <- tESV2[tESV2$pident >= 100, ]
tESV2 <- data.frame(Strain = trimws(tESV2$sseqid), ESV = tESV2$qseqid, pident = tESV2$pident)
tESV <- tESV2
tESV <- tESV[tESV$Strain %in% names(modules), ]
tCount <- read.csv(files[grepl("tim.*count", files)])
tCount[-1] <- Map(as.numeric, tCount[-1])
# only keep chitin bead data
tCount <- tCount[grepl("X|Beads.*Chitin", names(tCount))]
tCount[-1] <- Map(function(x) x / sum(x), tCount[-1])
tmp <- tCount[1, ]
tmp <- tmp[-1, ]
# combine ESVs that match isolate 16S
for (id in unique(tESV$Strain)) {
  esvs <- tESV$ESV[tESV$Strain == id]
  ri <- tCount$X %in% esvs
  freqs <- colSums(tCount[ri, -1])
  tmp <- rbind(tmp, c(id, freqs))
}
tmp[-1] <- Map(as.numeric, tmp[-1])
colnames(tmp) <- colnames(tCount)
tCount <- tmp
rownames(tCount) <- tCount$X
#tCount <- tCount[-1]
cn <- gsub("Beads_Chitin_", "", colnames(tCount)[-1])
tcx <- as.integer(gsub("_.+$", "", cn))
tcr <- gsub("^.+_","",cn)
rns <- rownames(tCount)
names(rns) <- tCount[,1]
tslp <- t(apply(tCount,1,ave_slope,tcr,tcx,rns,F))
tslp <- tslp[setdiff(rownames(tslp),rownames(mslp)),]
tslp <- tslp[!is.na(tslp[,1]),]

slp <- data.frame(id=c(rownames(tslp),rownames(mslp)),
                  slp=c(tslp[,1],mslp[,1]),
                  maxfreq=c(tslp[,2],mslp[,2]),
                  nonzero=c(tslp[,3],mslp[,3]),
                  cor=c(tslp[,4],mslp[,4]))
slp <- slp[slp$maxfreq>1e-3 & slp$cor>=.4,]

slpdf <- data.frame(module = modules[slp[,1]], s = slp[,2])
slpdf <- slpdf[!is.na(slpdf$s) & slpdf$s > 0, ]
l <- lm(log10(s) ~ module, slpdf)
sl <- summary(l)
chidf <- data.frame(module = chitinases[slp[,1]], s = slp[,2])
chidf <- chidf[!is.na(chidf$s) & chidf$s > 0, ]
l2 <- lm(log10(s) ~ module, chidf)
sl2 <- summary(l2)
message(sprintf("sl1 = %s, sl2 = %s",
                round(sl$adj.r.squared,2),round(sl2$adj.r.squared,2)))

c1 <- slpdf
c11 <- cor(c1,method="spearman")[2]
c12 <- cor(c1,method="pearson")[2]
c1 <- c(c11,c12)
c2 <- chidf
c21 <- cor(c2,method="spearman")[2]
c22 <- cor(c2,method="pearson")[2]
c2 <- c(c21,c22)

# statistics about separation induced by each measure
# x for expected number of chitinases
# x2 for observed number of chitinases
x <- slpdf
x$grp <- x$module>.5
t.test(x[x$grp,"s"],x[!x$grp,"s"])
mean(x[x$grp,2]) / mean(x[!x$grp,2])
x2 <- chidf
x2$grp <- x2$module>.5
t.test(x2[x2$grp,"s"],x2[!x2$grp,"s"])
mean(x2[x2$grp,2]) / mean(x2[!x2$grp,2])


f <- function(x) c(mean=mean(log10(x)),sd=sd(log10(x)))
a1 <- aggregate(slpdf$s,list(expected=slpdf[,1]<.5),FUN=f)
a1$type <- "E"
a1 <- as.matrix(a1)
a2 <- aggregate(chidf$s,list(observed=chidf[,1]==0),FUN=f)
a2$type <- "O"
a2 <- as.matrix(a2)
colnames(a2) <- colnames(a1) <- c("has_chitinase","mean","sd","type")
a <- as.data.frame(rbind(a1,a2))
for(i in 2:3) a[[i]] <- as.numeric(a[[i]])

p <- ggplot(a,aes(x=type,y=mean,ymin=mean-sd,ymax=mean+sd,fill=has_chitinase)) + 
  geom_pointrange(position=position_dodge(width=.3),shape=21) + 
  theme_shaul(base_size=8) +
  theme(legend.position="none") +
  scale_fill_manual(values=c("black","white"))
ggsave(p,file="fig3c.svg",w=1.2,h=1.4)
