###
# preprocessing for figure 1
#
# bash script that edits a template bash script and submit it to the SLURM 
# workload manager
###

#!/bin/bash
maxjobs=450
scriptname="003_rand_test.slurm"
template="003.template"
for s in {1..5000..50}
do
  # make sure there are not too many jobs running
  nl=$(squeue -u shaulp -r | wc -l) 
  if [ $nl -gt $maxjobs ]
  then
    while [ $nl -gt $maxjobs ]
    do
      [ -f core.* ] && rm core.*
      sleep 120
      nl=$(squeue -u shaulp -r | wc -l) 
    done
  fi
  # edit sbatch script
  let "e=$s+50-1"
  echo "$s..$e"
  cat $template | sed "s/ind1/$s/" | sed "s/ind2/$e/" > $scriptname
  sbatch "$scriptname"
  sleep 10
done
