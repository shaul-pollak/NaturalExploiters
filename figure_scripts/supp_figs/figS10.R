rm(list=ls())
library(readxl)
library(tidyr)
library(ggplot2)
library(RColorBrewer)
library(patchwork)
fix_cols <- function(x)
{
  I <- which(grepl("\\.\\.\\.",colnames(x)))
  types <- strsplit(colnames(x)[I],"\\.\\.\\.")
  types <- sapply(types,"[[",1)
  types <- paste(types,rep(1:2,length(types)/2),sep = "_")
  colnames(x)[I] <- types
  return(x)
}
gfp <- fix_cols(read_excel("data/200918_coculture_A3R04_1A01.xlsx",sheet=2))
rfp <- fix_cols(read_excel("data/200918_coculture_A3R04_1A01.xlsx",sheet=3))
od <- fix_cols(read_excel("data/200918_coculture_A3R04_1A01.xlsx",sheet=1))

# find bad A3R04 repeat
fx <- function(od,clr)
{
  od2 <- pivot_longer(od,-1)
  names(od2)[1] <- "time"
  ggplot(od2,aes(time,value,col=name)) + geom_point() + 
    scale_color_manual(values=clr) + 
    theme_shaul(base_size=7)
}
bad <- "A3R04_90%_2"
gfp <- gfp[,colnames(gfp)!=bad]
rfp <- rfp[,colnames(rfp)!=bad]

gfp_A3R06only <- gfp[,c(4,7:11)]
clr <- brewer.pal(length(colnames(gfp_A3R06only)[-1]),"Greys")
names(clr) <- colnames(gfp_A3R06only)[-1]

x <- c(rfp[[5]],rfp[[6]])
y <- c(gfp[[5]],gfp[[6]])
y <- y[x>5000]
x <- x[x>5000]
l <- lm(y ~ x)

b1 <- "skyblue"
b2 <- "#004488"
b3 <- colorRampPalette(c(b1,b2))
g1 <- "gold1"
g2 <- "#ddaa33"
g3 <- colorRampPalette(c(g1,g2))
blues <- c(b3(3),"grey")
nms <- colnames(gfp)[c(12:ncol(gfp),8:9)]
names(blues) <- gsub("_"," ",unique(gsub("_\\d+$","",nms)))
golds <- c(rev(g3(3)),"grey")
nms <- colnames(rfp)[c(12:ncol(rfp),5:6)]
names(golds) <- gsub("_"," ",unique(gsub("_\\d+$","",nms)))
gfp_mixed <- gfp[,c(4,c(12:ncol(gfp),8:9))]
rfp_mixed <- rfp[,c(4,c(12:ncol(rfp),5:6))]
for(i in 2:7)
{
  gfp_mixed[[i]] <- gfp_mixed[[i]] - predict.lm(l,data.frame(x=rfp_mixed[[i]]))
}
for(i in 8:9) gfp_mixed[[i]] <- gfp_mixed[[i]] - mean(gfp_mixed[[i]])
m1 <- gfp[[5]]-predict(l,data.frame(x=rfp[[5]]))
m2 <- gfp[[6]]-predict(l,data.frame(x=rfp[[6]]))
m <- mean(c(m1,m2)) + 2*sd(c(m1,m2))
fx <- function(od,clr,only50=F)
{
  clr2 <- adjustcolor(clr,alpha.f=.5)
  names(clr2) <- names(clr)
  od2 <- pivot_longer(od,-1)
  names(od2)[1] <- "time"
  od2$rpt <- as.character(sapply(od2$name,function(x) substr(x,nchar(x),nchar(x))))
  nm <- gsub("_\\d+$","",od2$name)
  nm <- gsub("_"," ",nm)
  od2$name <- nm
  if(only50) od2 <- od2[grepl("50%",od2$name),]
  f <- function(x) c(mean(x),sd(x))
  agg <- aggregate(od2$value,list(name=od2$name,time=od2$time),FUN=f)
  agg1 <- agg[,1:2]
  agg2 <- as.matrix(agg[,3])
  colnames(agg2) <- c("mean","sd")
  agg2 <- as.data.frame(agg2)
  agg <- cbind(agg1,agg2)
  ggplot(agg,aes(time,mean,col=name,fill=name)) + 
    geom_ribbon(aes(ymin=mean-sd, ymax=mean+sd),col=NA) +
    geom_line(size=2) + 
    scale_color_manual(values=clr) +
    scale_fill_manual(values=clr2) +
    theme_shaul(base_size=8)
}
p1 <- fx(gfp_mixed,blues,T) + labs(y=NULL,x=NULL) + theme(legend.position="none")
p2 <- fx(rfp_mixed,golds,T) + labs(y=NULL,x=NULL) + theme(legend.position="none")
p3 <- p2 + p1 
ggsave("figS10.svg",p3,h=2.1,w=3.3)
