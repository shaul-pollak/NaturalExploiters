rm(list=ls())
library(readxl)
library(tidyr)
library(ggplot2)
library(RColorBrewer)
library(patchwork)
extract_region <- function(ptrn,raw)
{
  redi <- which(grepl(ptrn,raw[[1]]))
  cns <- raw[(redi+1),]
  rfp <- raw[(redi+2):nrow(raw),]
  colnames(rfp) <- cns
  out <- list(data=rfp,raw=raw[1:(redi-1),])
  return(out)
}
get_data <- function(cns,od,rfp,gfp)
{
  nr <- min(nrow(od),nrow(rfp),nrow(gfp))
  out <- list()
  out$raw <- list()
  out$od <- data.frame(time=od[[2]][1:nr]/3600,mean=0,sd=0)
  out$rfp <- data.frame(time=od[[2]][1:nr]/3600,mean=0,sd=0)
  out$gfp <- data.frame(time=od[[2]][1:nr]/3600,mean=0,sd=0)
  out$raw$od <- od[1:nr,cns] - mean(od[["A1"]],na.rm=T)
  out$raw$rfp <- rfp[1:nr,cns] - mean(rfp[["A1"]],na.rm=T)
  out$raw$gfp <- gfp[1:nr,cns] - mean(gfp[["A1"]],na.rm=T)
  fx <- function(y) t(apply(y,1,function(x) c(mean(x),sd(x))))
  out$od[,2:3] <- fx(out$raw$od)
  out$rfp[,2:3] <- fx(out$raw$rfp)
  out$gfp[,2:3] <- fx(out$raw$gfp)
  return(out)
}

raw <- read_excel("data/Yuya_DsRed_GFP_timecourse_20201130_190938.xlsx")
l <- extract_region("DsRed",raw)
raw <- l$raw
rfp <- l$data
l <- extract_region("eGFP",raw)
raw <- l$raw
gfp <- l$data
l <- extract_region("OD",raw)
od <- l$data
for(i in 1:ncol(od))
{
  od[[i]] <- as.numeric(od[[i]])
  rfp[[i]] <- as.numeric(rfp[[i]])
  gfp[[i]] <- as.numeric(gfp[[i]])
}

rd <- paste0(LETTERS[1:4],5)
gd <- paste0(LETTERS[5:8],5)
toplotR <- get_data(rd,od,rfp,gfp)
toplotG <- get_data(gd,od,rfp,gfp)

save(list=c("toplotR","toplotG"),file="data/A3R04_gfp.RData")
