library(tidyverse)
library(patchwork)
# p1
genotypes <- c('1A01','6D03','6C06','6D02','I2M19','I2R16','1A06','1C10')
dils <- 4^(rep(c(0,-1,-2,-3,-4,-5),each=2))
tbl <- readxl::read_excel('data/Shaul_SybrGold_20190207_15_min.xlsx',ski=43) %>%
    .[1:8,-1] %>% gather()  %>% type_convert() %>%
    mutate(genotype = rep(genotypes,12),dilution = dils[key])
blnk <- tbl %>% filter(key %in% c(11,12)) %>% summarize(blank=mean(value))
tbl$value <- tbl$value-blnk$blank
cfu <- c(32*10^6,624*10^6,100*10^7,1584*10^6,766*10^6,150*10^6,200*10^5,50*10^5)
names(cfu) <- c('6D02','1A06','1C10','1A01','6D03','I2M19','I2R16','6C06')
cfu <- cfu/.9 # i measured 90 ul cells mixed with 10 ul sybr gold
tbl2 <- tbl %>% filter(genotype %in% names(cfu)) %>%
    mutate(cfu=cfu[genotype]*dilution)
tbl3 <- tbl2[tbl2$cfu>=8e4 & !(tbl2$genotype %in% c("1A06","1C10")),]
p1 <- ggplot(tbl3,aes(cfu,value,col=genotype)) + 
    geom_smooth(method="lm",formula=y~x,se=F) +
    geom_point() +
    scale_x_log10() +
    scale_y_log10() +
    theme_shaul(x.label.rotation=45,base_size=8) + 
    theme(aspect.ratio=1) +
    ggsci::scale_color_npg() +
    labs(x="CFU/ml",y="Fluorescence [a.u]")

tbl4 <- tbl3[,c("genotype","cfu","value")]
for (i in 2:3) tbl4[[i]] <- log10(tbl4[[i]])
l <- lm(value ~ cfu * genotype,data=tbl4)
sl <- as.data.frame(coefficients(summary(l)))
names(sl)[4] <- "pvalue"
sl$name <- rownames(sl)
p2 <- ggplot(sl[grepl(":",sl$name),],aes(gsub("cfu:genotype","",name),pvalue)) + 
    geom_col(color="black",fill="black") + 
    geom_hline(yintercept=0.05,col="grey") +
    theme_shaul(x.label.rotation=45,base_size=8) +
    theme(aspect.ratio=1) +
    labs(x="Strain")

# p3
t15 <- readxl::read_excel('data/Shaul_SybrGold_20190205_15Min.xlsx',ski=43) 
t15 <- t15[1:8,-1] %>% gather() %>%
    mutate(bead_dilution=rep(rep(c(0,-1,-2,-3),each=2),12)) %>%
    filter(value!='OVER') %>% type_convert()
# subtract blanks
bl <- t15$value %>% tail(n=2)
t15[,2] <- t15[,2] - mean(bl)
t15 <- t15 %>% tail(-2) %>% filter(value>10)
dils <- c(0:-10,-12)
clr <- ggsci::pal_npg()(5)
t15 <- t15 %>% mutate(dilution = 2^dils[t15$key],col=clr[ ((-1* bead_dilution )+1) ])
t15[t15$dilution==2^-12,'col'] <- clr[ 5 ]
l <- lm(log10(value) ~ log10(dilution), t15[log2(t15$dilution) > -8,])
cfs <- coefficients(l)
rdf <- data.frame(xmin=10^(-3.2),xmax=10^-2,ymin=min(t15$value),ymax=max(t15$value))
blk <- adjustcolor("grey",alpha.f=.7)
p3 <- ggplot() + 
    geom_rect(aes(xmin=xmin,xmax=xmax,ymin=ymin,ymax=ymax),data=rdf,fill=blk,col=NA) +
    geom_abline(intercept=cfs[1],slope=cfs[2]) +
    geom_point(aes(dilution,value,shape=factor(bead_dilution),
                   col=factor(bead_dilution)),
               data=t15,size=2) +
    annotate("text", x = 0.0025, y = 30000, label = "Noise",size=3) +
    scale_x_log10() +
    scale_y_log10(limits=c(min(t15$value),max(t15$value))) +
    labs(x="cell dilution", y = "Fluorescence [a.u]",col="particle dilution",
         shape="particle dilution") +
    ggsci::scale_color_aaas() +
    theme_shaul(x.label.rotation=45,base_size=8) +
    geom_hline(yintercept=1000) +
    theme(aspect.ratio=1)
p5 <- (p1 + p2 + p3) + patchwork::plot_annotation(tag_levels="A") + plot_layout()
p5
ggsave(plot=p5,file="../FigS7.svg",w=7.25,h=4)
