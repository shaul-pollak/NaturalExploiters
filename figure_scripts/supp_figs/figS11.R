rm(list=ls())
library(readxl)
library(tidyr)
library(ggplot2)
library(RColorBrewer)
library(patchwork)
fix_cols <- function(x)
{
  I <- which(grepl("\\.\\.\\.",colnames(x)))
  types <- strsplit(colnames(x)[I],"\\.\\.\\.")
  types <- sapply(types,"[[",1)
  types <- paste(types,rep(1:2,length(types)/2),sep = "_")
  colnames(x)[I] <- types
  return(x)
}
gfp <- fix_cols(read_excel("data/200918_coculture_A3R04_1A01.xlsx",sheet=2))
rfp <- fix_cols(read_excel("data/200918_coculture_A3R04_1A01.xlsx",sheet=3))
od <- fix_cols(read_excel("data/200918_coculture_A3R04_1A01.xlsx",sheet=1))

# find bad A3R04 repeat
fx <- function(od,clr)
{
  od2 <- pivot_longer(od,-1)
  names(od2)[1] <- "time"
  ggplot(od2,aes(time,value,col=name)) + geom_point() + 
    scale_color_manual(values=clr) + 
    theme_shaul(base_size=7)
}
bad <- "A3R04_90%_2"
gfp <- gfp[,colnames(gfp)!=bad]
rfp <- rfp[,colnames(rfp)!=bad]

fix_scale <- function(tmp)
{
  af <- function(x) aggregate(x,by=list(time=tmp$time),FUN=mean)
  af2 <- function(x) aggregate(x,by=list(time=tmp$time),FUN=sd)
  af3 <- function(x) max(x$x) / min(x$x)
  a_od <- af(tmp$od) 
  a_rfp <- af(tmp$rfp)
  sd_rfp <- af2(tmp$rfp)
  out_rfp <- cbind(a_rfp,sd=sd_rfp$x)
  c1 <- af3(a_rfp) 
  c2 <- max(tmp$od-min(tmp$od))
  a_od2 <- af(((tmp$od-min(tmp$od))*c1/c2+1)*min(a_rfp$x))
  sd_od2 <- af2((tmp$od-min(tmp$od))*c1/c2+1)*min(a_rfp$x)
  out_od <- cbind(a_od2,sd=sd_od2$x)
  return(list(rfp=out_rfp,od=out_od,od_orig=a_od,a=min(a_rfp$x),b=c1/c2,c=min(tmp$od)))
}
tmp <- data.frame(od=c(od[[5]],od[[6]]),rfp=c(rfp[[5]],rfp[[6]]),time=rep(rfp[[4]],2))
lst <- fix_scale(tmp)
p1 <- ggplot(lst[[1]],aes(x=time,y=x)) + 
  geom_ribbon(aes(ymin=x-sd,ymax=x+sd),fill=adjustcolor("firebrick",alpha.f=.5),col=NA) +
  geom_line(col="firebrick") + 
  geom_ribbon(data=lst[[2]],aes(ymin=x-sd,ymax=x+sd),fill=adjustcolor("black",alpha.f=.5),col=NA) +
  geom_line(data=lst[[2]],col="black") +
  scale_y_continuous("Fluorescence",sec.axis = sec_axis(~ ((. + lst$c)/lst$b-1)/lst$a, name = "OD")) +
  theme_shaul(base_size=8) +
  theme(axis.line.y.left=element_line(color="firebrick"),
        axis.ticks.y.left=element_line(color="firebrick"),
        axis.text.y.left=element_text(color="firebrick"),
        axis.title.y.left=element_text(color="firebrick"),aspect.ratio=1) +
  labs(x="Time [h]")
p2 <- ggplot(tmp,aes(rfp,od)) + 
  geom_point(size=.5) +
  theme_shaul(base_size=8) +
  theme(aspect.ratio=1) +
  annotate("text",x=15000,y=0.2,label=sprintf("r = %s",round(cor(tmp[,1:2])[2],2)),size=1) +
  labs(x="RFP fluorescence [a.u]",y="Optical density [600nm]")

load("data/A3R04_gfp.RData")
tmp <- data.frame(od=unlist(toplotG$raw$od),rfp=unlist(toplotG$raw$gfp),time=rep(toplotG$od[,1],ncol(toplotG$raw$gfp)))
lst <- fix_scale(tmp)
p3 <- ggplot(lst[[1]],aes(x=time,y=x)) + 
  geom_ribbon(data=lst[[2]],aes(ymin=x-sd,ymax=x+sd),fill=adjustcolor("black",alpha.f=.5),col=NA) +
  geom_line(data=lst[[2]],col="black") +
  geom_ribbon(aes(ymin=x-sd,ymax=x+sd),fill=adjustcolor("lightgreen",alpha.f=.5),col=NA) +
  geom_line(col="darkgreen") + 
  scale_y_continuous("Fluorescence",sec.axis = sec_axis(~ ((. + lst$c)/lst$b-1)/lst$a, name = "OD")) +
  theme_shaul(base_size=8) +
  theme(axis.line.y.left=element_line(color="darkgreen"),
        axis.ticks.y.left=element_line(color="darkgreen"),
        axis.text.y.left=element_text(color="darkgreen"),
        axis.title.y.left=element_text(color="darkgreen"),aspect.ratio=1) +
  labs(x="Time [h]")
p4 <- ggplot(tmp,aes(rfp,od)) + 
  geom_point(size=.5) +
  theme_shaul(base_size=8) +
  theme(aspect.ratio=1) +
  annotate("text",x=500,y=0.35,label=sprintf("r = %s",round(cor(tmp[,1:2])[2],2)),size=1) +
  labs(x="GFP fluorescence [a.u]",y="Optical density [600nm]")

p5 <- p1+p2+p3+p4+plot_annotation(tag_levels="A")+plot_layout(nrow=2,ncol=2,byrow=F)
ggsave(plot=p5,file="figS11.svg",w=7.5,h=6)
