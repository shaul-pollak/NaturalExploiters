graphics.off()
rm(list=ls())
library(openxlsx)
library(svglite)
library(phytools)
library(ggplot2)
library(latex2exp)
library(RColorBrewer)
library(ggtree)
source("functions.R")
get_time <- function(x) as.integer(regmatches(x,regexpr("\\d+$",x)))
get_rpt <- function(x) as.integer(gsub("^[^.]+.|[.][^.]+$","",x))
get_dil <- function(x) 
{
  out <- rep(1,length(x))
  rmtch <- regexpr("D\\d",x)
  out[rmtch>0] <- as.integer(gsub("^D","",regmatches(x,rmtch)))
  return(out)
}
norm_class <- function(x,rns,clsf)
{
  for(cls in unique(clsf[,3]))
  {
    ai <- rns %in% rownames(clsf)[clsf[,3]==cls]
    sm <- sum(x[ai])
    if(sm==0) next
    s <- x[ai]/sm
    x[ai] <- s
  }
  return(x)
}

# read isolate classification table
clsf <- read.table("../fig2/isolate_classification.tsv")
clsf[clsf[,1]>0 & clsf[,2]>=.5,3] <- "degrader"
clsf[clsf[,1]==0 & clsf[,2]>=.5,3] <- "exploiter"
clsf[clsf[,2]<.5,3] <- "scavenger"

tre <- read.newick("data/isolates.tree")
gtdb <- read.table("../fig2/data/gtdbtk.bac120.summary.tsv",header=T,sep="\t")
gtclsf <- gtdb$classification
gtclsf <- strsplit(gtclsf,'[;]?.__')
names(gtclsf) <- gtdb[,1]
gtclsf <- lapply(gtclsf,function(x) x[-1])
# define colors
clr <- c("#DDAA33","#006cdaff","#000000")
names(clr) <- c('degrader','exploiter','scavenger')
# read file
df <- read.csv('data/feature_table.csv')
# remove C1 and matti's other experiments
cols.tokeep <- substr(colnames(df),1,4) %in% c(paste0("L.C",c(1:4)),"X","L.T0") 
cols.tokeep <- cols.tokeep & !grepl('P',colnames(df))
cols.tokeep <- cols.tokeep & grepl('^X|C\\d|T0',colnames(df))
df <- df[,cols.tokeep]
df[-1] <- apply(df[-1],2,as.numeric)
rm(cols.tokeep)
colnames(df) <- gsub("^L[.]","",colnames(df))
colnames(df) <- gsub("_",".",colnames(df))
df[-1] <- apply(df[-1],2,function(x) x/sum(x)) # turn counts into freqs
# turn strain df into archetype df
load("data/pheno.RData") # load phenotyping data
clsf[rownames(pheno),3] <- pheno$phenotype

archetypes <- unique(clsf$class)
df.a <- df[1:length(archetypes),]
df.a$X <- archetypes
for(atype in archetypes){
  ri1 <- df$X %in% rownames(pheno)[pheno$phenotype==atype]
  ri2 <- !(df$X %in% rownames(pheno))
  ri2 <- ri2 & df$X %in% rownames(clsf)[clsf$class==atype]
  if(sum(ri2)>0) message(atype)
  ri <- ri1 | ri2
	x <- colSums(df[ri,-1])
	df.a[df.a$X==atype,-1] <- x
}
df.a[,-1] <- sapply(df.a[,-1],function(x) x/sum(x))
tre <- keep.tip(tre,df$X)
# find experimental types
t0idx <- which(grepl("T0",colnames(df)))-1
exp.type <- gsub("[.].+$","",colnames(df.a)[-1])
rpt <- rep(0,ncol(df.a)-1)
rptt <- regmatches(colnames(df.a[-1]),regexpr('[.]\\d+[.]',colnames(df.a[-1])))
rptt <- gsub("[.]","",rptt)
rptt <- as.numeric(rptt)
rpt[grepl('[.]\\d+[.]',colnames(df.a[-1]))] <- rptt
time.point <- gsub("^[^T]*T","",colnames(df.a[-1]))
time.point <- as.numeric(time.point)
save.image("data/fig4.RData")
