###
# this script generates the plots accompanying Fig3b
# the output can be found in supplementary ../figure S14
###

rm(list=ls())
require(openxlsx)
require(Matrix)
require(svglite)
require(latex2exp)
require(ggplot2)
require(patchwork)
require(outliers)
require(zoo)
isoDF <- read.table("../fig2/isolate_classification.tsv")
isoDF[isoDF[,1]>0 & isoDF[,2]>.5,3] <- "degrader"
isoDF[isoDF[,1]==0 & isoDF[,2]>.5,3] <- "exploiter"
isoDF[isoDF[,2]<=.5,3] <- "scavenger"
minfreq <- 1e-4
# get names of isolates to process
load("../fig2/fluo_all3.RData")
iso.names <- unique(mx3$strain) 
rm(mx3,fl)

# get files to process
files <- dir("../fig3/data",full.names=T)

## process Manoshi's data
mESV <- read.xlsx("../fig3/data/manoshi_otuToStrain.xlsx")
mESV <- mESV[mESV[, 1] %in% rownames(isoDF), ]
mCount <- read.table("../fig3/data/manoshi_count.txt", sep = "\t", header = T)
nmat <- matrix(0, nrow = (ncol(mCount) - 1), ncol = (ncol(mCount) - 1))
diag(nmat) <- 1 / colSums(mCount[, -1])
mCount[, -1] <- as.matrix(mCount[, -1]) %*% nmat
mCount <- mCount[mCount$OTUId %in% mESV$OTU[!is.na(mESV$OTU)], ]
colsTokeep <- grepl("^OTU|^M", colnames(mCount))
mCount <- mCount[, colsTokeep]
rownames(mCount) <- mESV$Strain[match(mCount$OTUId, mESV$OTU)]
times <- gsub("^M.+T", "", colnames(mCount[, -1]))
times <- as.integer(times)
rpt <- gsub("\\..+$","",colnames(mCount)[-1])
rnsm <- rownames(mCount)
names(rnsm) <- mCount[,1]

## process Tim's data
tESV2 <- read.delim(files[grepl("16s.+[.]tsv", files)])
tESV2 <- tESV2[tESV2$pident >= 100, ]
tESV2 <- data.frame(Strain = trimws(tESV2$sseqid), ESV = tESV2$qseqid, pident = tESV2$pident)
tESV <- tESV2
tESV <- tESV[tESV$Strain %in% rownames(isoDF), ]
tCount <- read.csv(files[grepl("tim.*count", files)])
tCount[-1] <- Map(as.numeric, tCount[-1])
# only keep chitin bead data
tCount <- tCount[grepl("X|Beads.*Chitin", names(tCount))]
tCount[-1] <- Map(function(x) x / sum(x), tCount[-1])
tmp <- tCount[1, ]
tmp <- tmp[-1, ]
# combine ESVs that match isolate 16S
for (id in unique(tESV$Strain)) {
  esvs <- tESV$ESV[tESV$Strain == id]
  ri <- tCount$X %in% esvs
  freqs <- colSums(tCount[ri, -1])
  tmp <- rbind(tmp, c(id, freqs))
}
tmp[-1] <- Map(as.numeric, tmp[-1])
colnames(tmp) <- colnames(tCount)
tCount <- tmp
rownames(tCount) <- tCount$X
#tCount <- tCount[-1]
cn <- gsub("Beads_Chitin_", "", colnames(tCount)[-1])
tcx <- as.integer(gsub("_.+$", "", cn))
tcr <- gsub("^.+_","",cn)
rnst <- rownames(tCount)
names(rnst) <- tCount[,1]

f1 <- function(x,times,rns)
{
  out <- NULL
  for (strn in rns) 
  {
    xtmp <- as.vector(unlist(x[strn,-1]))
    tdf <- aggregate(xtmp,by=list(strain=rep(strn,length(times)),time=times),FUN=mean)
    names(tdf)[3] <- "freq"
    tdf$freq[tdf$freq < minfreq] <- 0
    if(mean(tdf$freq)<minfreq) next
    if(is.null(out))
    {
      out <- tdf
    } else
    {
      out <- rbind(out,tdf)  
    }
  }
  return(out)
}
classnorm <- function(x)
{
  for (cl in unique(x$clsf))
  {
    m <- max(x$freq[x$clsf==cl])
    x$freq[x$clsf==cl] <- x$freq[x$clsf==cl] / m
  }
  return(x)
}
timestep <- function(x)
{
  out <- NULL
  mt <- max(x$time)
  for(strn in unique(x$strain))
  {
    xt <- x[x$strain==strn,]
    xt$x1 <- xt$time
    xt$x2 <- 0
    xt$x2[2:nrow(xt)-1] <- xt$x1[2:nrow(xt)]
    xt$x2[nrow(xt)] <- mt+10
    xt$mx <- xt$time[xt$freq==max(xt$freq)]
    if (is.null(out))
    {
      out <- xt
    } else
    {
      out <- rbind(out,xt)
    }
  }
  return(out)
}
mf1 <- f1(mCount,times,rownames(mCount))
tf1 <- f1(tCount,tcx,rnst)
tf1 <- tf1[tf1$strain %in% setdiff(tf1$strain,mf1$strain),]
df <- rbind(mf1,tf1)
df$clsf <- isoDF[df[[1]],3]
df <- df[df$strain %in% iso.names,]
df$freq[df$freq<minfreq] <- 0
#df <- classnorm(df)
df <- timestep(df)
ymap <- unique(df[,c(1,4,7)],dim=1)
ymap <- ymap[order(ymap[[2]],ymap[[3]],decreasing=T),]
df$y <- match(df$strain,ymap$strain)

clrscl = c("black","#956404ff","#ef8b09ff","#f35c09ff","red")
p1 <- ggplot(df,aes(ymin=y-.5,ymax=y+.5,xmin=x1,xmax=x2,fill=log10(freq))) + 
  geom_rect() + theme_minimal() + scale_fill_gradientn(colours = clrscl ,na.value="black") +
  scale_y_continuous(breaks=1:nrow(ymap),labels=ymap[[1]]) + theme(legend.position="top")
getorder <- function(x) gsub("^f__","",strsplit(x,";")[[1]][5])
gtdb <- read.table("../fig2/data/gtdbtk.bac120.summary.tsv",sep="\t",header=T)
taxord <- sapply(gtdb[[2]],getorder)
names(taxord) <- gtdb[[1]]

taxdf <- data.frame(id = unique(df$strain[order(df$y)]),fam=taxord[unique(df$strain[order(df$y)])])

f <- function(i,x,d)
{
  y <- unlist(d[i,])
  a <- aggregate(y,by=list(x=x),FUN=mean)
  #a[,2] <- a[,2]/max(a[,2]) 
  out <- cbind(a,rep(i,nrow(a)))
  names(out) <- c("time","freq","i")
  return(out)
}
mn <- do.call(rbind,lapply(1:nrow(mCount),f,x=times,d=mCount[,-1]))
mn$i <- rownames(mCount)[mn$i]
tn <- do.call(rbind,lapply(1:nrow(tCount),f,x=tcx,d=tCount[,-1]))
tn$i <- rownames(tCount)[tn$i]
tn <- tn[!(tn$i %in% mn$i),]
n <- rbind(mn,tn)
n$clsf <- isoDF[n$i,3]
n2 <- n[!is.na(n$freq),]
n2 <- n2[n2$i %in% iso.names,]
na <- aggregate(n2$freq,by=list(time=n2$time,clsf=n2$clsf),FUN=mean)
tmp <- tidyr::pivot_wider(na,names_from=clsf,values_from=x)
tmp <- as.data.frame(cbind(tmp[[1]][1:(nrow(tmp)-2)],
                           apply(tmp[,-1],2,zoo::rollmean,k=3,align="right")))
n <- tidyr::pivot_longer(tmp,-1)
clr <- c(scavenger="#000000ff",exploiter="#006cdaff",degrader="#ddaa33ff")
p2 <- ggplot(n,aes(V1,value,col=name)) + 
  geom_line(size=2) + 
  scale_color_manual(values=clr) +
  theme_shaul() +
  theme(aspect.ratio=1) +
  scale_y_log10()
p <- p1+p2
ggsave(plot=p,file="FigS14.svg",h=4,w=10)
