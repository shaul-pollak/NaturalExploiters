rm(list=ls())
library(readxl)
library(tidyr)
library(ggplot2)
library(RColorBrewer)
library(patchwork)
fix_cols <- function(x)
{
  I <- which(grepl("\\.\\.\\.",colnames(x)))
  types <- strsplit(colnames(x)[I],"\\.\\.\\.")
  types <- sapply(types,"[[",1)
  types <- paste(types,rep(1:2,length(types)/2),sep = "_")
  colnames(x)[I] <- types
  return(x)
}
gfp <- fix_cols(read_excel("data/200918_coculture_A3R04_1A01.xlsx",sheet=2))
rfp <- fix_cols(read_excel("data/200918_coculture_A3R04_1A01.xlsx",sheet=3))
od <- fix_cols(read_excel("data/200918_coculture_A3R04_1A01.xlsx",sheet=1))

# find bad A3R04 repeat
fx <- function(od,clr)
{
  od2 <- pivot_longer(od,-1)
  names(od2)[1] <- "time"
  ggplot(od2,aes(time,value,col=name)) + geom_point() + 
    scale_color_manual(values=clr) + 
    theme_shaul(base_size=7)
}
bad <- "A3R04_90%_2"
gfp <- gfp[,colnames(gfp)!=bad]
rfp <- rfp[,colnames(rfp)!=bad]

x <- c(rfp[[5]],rfp[[6]])
y <- c(gfp[[5]],gfp[[6]])
y <- y[x>5000]
x <- x[x>5000]
l <- lm(y ~ x)
cr <- cor(unlist(rfp[,5],rfp[,6]),unlist(gfp[,5],gfp[,6]))

agg <- function(df)
{
  tmp <- tidyr::pivot_longer(df,-1)
  toplot <- aggregate(tmp$value,by=list(time=tmp[[1]]),FUN=mean)
  tmp2 <- aggregate(tmp$value,by=list(time=tmp[[1]]),FUN=sd)
  toplot$sd <- tmp2$x
  return(toplot)
}
toplotR <- agg(rfp[,4:6])
toplotR$col <- "RFP"
toplotG <- agg(gfp[,4:6])
toplotG$col <- "GFP"
toplot <- rbind(toplotR,toplotG)
p1 <- ggplot(toplot,aes(time,x,col=col,fill=col)) + 
  geom_ribbon(aes(ymin=x-sd,ymax=x+sd),col=NA) +
  geom_line(size=2) +
  scale_fill_manual(values=adjustcolor(rev(c("red1","green1")),alpha.f=.5)) +
  scale_color_manual(values=rev(c("red3","green3"))) +
  theme_shaul(base_size=8) + theme(legend.position="none") +
  labs(y = "fluorescence [a.u]", x = "time [h]") +
  ggtitle("1A01-RFP")
p2 <- ggplot(data.frame(x=x,y=y),aes(x,y)) + 
  geom_smooth(method="lm",col="darkgrey",formula=y~x) +
  geom_point() + 
  theme_shaul(base_size=8) + theme(legend.position="none") +
  labs(x = "RFP fluorescence", y = "GFP fluorescence") +
  ggtitle("1A01-RFP")

gfp_mixed <- gfp[,c(4,12:ncol(gfp))]
rfp_mixed <- rfp[,c(4,12:ncol(rfp))]
for(i in 2:7)
{
  gfp_mixed[[i]] <- gfp_mixed[[i]] - predict.lm(l,data.frame(x=rfp_mixed[[i]]))
}
agg_max <- function(df)
{
  lng <- pivot_longer(df[,-(1:3)],-1)
  a <- aggregate(lng$value,by=list(time=lng[[1]],type=gsub("_\\d+$","",lng$name)),mean)
  return(max(a[[3]]))
}
mR <- agg_max(rfp)
mG <- agg_max(gfp)
bR <- mean(c(rfp[[8]],rfp[[9]]))
bG <- mean(gfp_mixed[[2]][gfp_mixed[[1]]<=20])
f <- function(nm)
{
  x <- gfp_mixed[[1]]
  agfx <- function(df,bg,mg)
  {
    yG <- pivot_longer(cbind(x,(df[grepl(nm,names(df))] - bg) / mg),-1)
    aG <- aggregate(yG$value,by=list(time=yG$x),FUN=mean)
    tmp <- aggregate(yG$value,by=list(time=yG$x),FUN=sd)
    aG$sd <- tmp$x
    return(aG)
  }
  yG <- agfx(gfp_mixed,bG,mG)
  yR <- agfx(rfp_mixed,bR,mR)
  ggplot(yR,aes(time,x,ymin=x-sd,ymax=x+sd)) + 
    geom_ribbon(col=NA,fill=adjustcolor("red3",alpha.f=.5)) + 
    geom_line(size=2,col="red3") +
    geom_ribbon(data=yG,fill=adjustcolor("darkgreen",alpha.f=.5),col=NA) +
    geom_line(data=yG,size=2,col="darkgreen") +
    theme_shaul(base_size=8) +
    labs(x = "time [h]", y = "normalized fluorescence") +
    scale_y_continuous(limits=c(-.02,.7)) +
    ggtitle(nm)
}
nms <- unique(gsub("_\\d+$","",names(gfp_mixed)[-1]))
pl <- lapply(nms,f)
pp1 <- p1+p2
pp2 <- pl[[1]] + pl[[2]] + pl[[3]]
out <- pp1 / pp2 + plot_annotation(tag_levels="A")
ggsave(plot=out,file="FigS12.svg",w=7.25,h=4)
