###
# Preprocessing for figure 1
#
# this script uses output of dbcan to infer ancestral counts of chitinases
#
# the output of this script is used in Figure 1C
###

# load libraries
rm(list=ls())
library(phytools)
library(castor)
library(Matrix)
library(data.table)

# paths
hmmpath <- "../output/dbcan/filtered_output/chitinases_domtbl.txt"
tre_path <- "../output/gtdbtk/binary.tree"

# keep relevant part of tree
tre <- read.tree(tre_path)
tre <- keep.tip(tre,tre$tip.label[grepl("\\.fna$",tre$tip.label)])
tre$tip.label <- gsub("\\.fna$","",tre$tip.label)

# process hmm
hmm <- fread(hmmpath)
invisible(hmm[,genome:=gsub("_\\d+$","",V1)])
cnt <- hmm[,length(unique(V1)),by=genome]
chi <- rep(0,length(tre$tip.label))
names(chi) <- tre$tip.label
cnt2 <- cnt[cnt$genome %in% names(chi),]
chi[cnt2$genome] <- cnt2$V1

# anc recon
anc.chit <- c(chi,
  round(asr_squared_change_parsimony(tre,chi)$ancestral_states))
names(anc.chit) <- c(names(chi),paste0("node_",1:tre$Nnode))
# get names of cogs that contain chitinases
tsv <- fread("../output/linclust/0.5.tsv",header=F)
chi_genes <- tsv[V2 %in% unique(hmm$V1),unique(V1)]

save(list=c("anc.chit","chi_genes"),file="../output/chit_anc.RData")
