###
# preprocessing for figure 1
#
# utility script that combines all of the individual randomization test
# performed in step 003
###

require(Matrix)
require(castor)
require(phytools)
require(data.table)
rm(list=ls())
source("~/nfs2/chitin_v2/scripts/rand_test_functions.R")

rdata_dir <- "../output/rand_test"
out_path_rtest <- "../output/rtest_combined.RData"
anc_path <- "../output/anc.RData"
sig_path <- "../output/sig_genes.RData"
hmmpath <- "../output/dbcan/filtered_output/chitinases_domtbl.txt"
cout <- combine_rand(rdata_dir,out_path_rtest)
pthresh <- 5e-2
corrthresh <- 0.0
idx <- !is.na(cout[[2]]) & 
  cout[[2]] < pthresh & 
  cout[[3]] > corrthresh & 
  !is.na(cout[[3]])
nms <- names(cout[[3]])[idx]

# add proximal genes
pe <- new.env()
load("../output/proximity.RData",pe)
nms <- union(nms,pe$np$gene)

# remove chitinases
k <- new.env()
load("../output/chit_anc.RData",k)
nms <- nms[! nms %in% k$chi_genes[[2]]]

# save
e <- new.env()
load(anc_path,e)
e$change.mat <- e$anc[e$tre$edge[,2],]-e$anc[e$tre$edge[,1],]
gensize <- e$change.mat[,"gensize"]
diffs <- e$change.mat[,nms]
save(list=c("diffs","gensize"),file=sig_path)
