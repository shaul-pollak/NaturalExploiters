require(data.table)
rm(list=ls())

# set default values for parameters
outputDir <- "../output/isolate_analysis"
queryDB <- "~/nfs2/our_genomes/mmseqs_db/our.db"
targetDB <- "../output/linclust/rep/rep"
searchOutDB <- paste0(outputDir, "/mmseqs_out")
tmpDir <- "/dev/shm/mmseqs_tmp"
moduleFile <- "../output/module_count.RData"
isolateHmmPath <- "~/nfs2/our_genomes/dbcan/chitinases_domtbl.txt"
RDataOutPath <- paste0(outputDir, "/isolates.RData")
covr <- 0.8
msid <- 0.5

# process command line arguments
arg <- commandArgs(trailingOnly = T)
if(length(arg)>1)
{
  outputDir <- arg[1]
  # make sure last character is not "/"
  outputDir <- gsub("/$", "", outputDir) 
  queryDB <- arg[2]
  targetDB <- arg[3]
  searchOutDB <- paste0(outputDir, "/mmseqs_out")
  moduleFile <- arg[4]
  isolateHmmPath <- arg[5]
  RDataOutPath <- paste0(outputDir, "/isolates.RData")
}

if(!dir.exists(outputDir)) dir.create(outputDir)
if(!file.exists(sprintf("%s.m8",searchOutDB)))
{
  # blast input file (proteomes) against representative sequences
  cmd_srch <- sprintf(paste0("mmseqs search %s %s %s %s ",
                             "-c %s --cov-mode 0 ",
                             "--min-seq-id %s --threads 20"), 
                      queryDB, targetDB, searchOutDB, tmpDir,covr,msid)
  system(cmd_srch)
  frmt <- '"query,target,pident,tcov,evalue"'
  cmd_cnvrt <- sprintf(paste0("mmseqs convertalis %s %s %s %s.m8 ",
                              "--format-output %s"),
                       queryDB, targetDB, searchOutDB, searchOutDB, frmt)
  system(cmd_cnvrt)
}

# read in modules file
load(moduleFile)

# read tsv
a <- fread("../output/linclust/0.5.tsv", header = F)
setkey(a,V2)

# read mmseqs search output
mmseqs_tbl <- read.delim(paste0(searchOutDB, ".m8"), sep = "\t",
                         header = F)
cond1 <- as.numeric(mmseqs_tbl[, 3]) >= msid
cond2 <- as.numeric(mmseqs_tbl[, 4]) >= covr
mmseqs_tbl <- mmseqs_tbl[cond1 & cond2, ]
toreplace <- a[mmseqs_tbl$V2,V1]
mmseqs_tbl$V2 <- toreplace
gnms <- unique(gsub("_\\d+$", "", mmseqs_tbl$V1))
mmseqs_tbl <- mmseqs_tbl[mmseqs_tbl$V2 %in% c$names, ]
mmseqs_tbl <- mmseqs_tbl[order(mmseqs_tbl$V1), ]

# resolve proteins that hit two target sequences
toResolve <- table(mmseqs_tbl$V1)
tokeep <- names(toResolve)[toResolve == 1]
filteredTable <- mmseqs_tbl[mmseqs_tbl$V1 %in% tokeep, ]
toResolve <- toResolve[toResolve > 1]
bhdiffs <- vector()
for (gn in names(toResolve)) {
  rtbl <- mmseqs_tbl[mmseqs_tbl$V1 == gn, ]
  evs <- order(-log10(rtbl$V5), decreasing = T)
  filteredTable <- rbind(filteredTable, rtbl[evs[1], ])
}
filteredTable$genome <- gsub("_\\d+$", "", filteredTable$V1)

isolateMdlMat <- matrix(0, nrow = length(gnms), ncol = max(c$membership))
rownames(isolateMdlMat) <- gnms
for (mdl in 1:max(c$membership)) {
  nms <- c$names[c$membership == mdl]
  rtbl <- filteredTable[filteredTable$V2 %in% nms, ]
  rtbl <- as.data.table(rtbl)
  rbln <- rtbl[, length(unique(V2)),by=genome]
  rbln$p <- rbln$V1/length(nms)
  isolateMdlMat[, mdl][rbln$genome[rbln$p>.3]] <- 1
}
colnames(isolateMdlMat) <- paste("module", 1:ncol(isolateMdlMat),
                                 sep = "_")
isolateMdl <- rowSums(isolateMdlMat)
isolateChi <- isolateMdl
isolateChi[] <- 0

# read isolate chitinase hmm out
isoHmm <- fread(isolateHmmPath)
setkey(isoHmm,V1,V13)
isoHmm <- isoHmm[unique(isoHmm$V1),mult="first"]
isolateChiTbl <- table(isoHmm$genome)
isolateChi[names(isolateChiTbl)] <- isolateChiTbl
save(list = c("isolateChi", "isolateMdlMat", "isolateMdl"),
     file = RDataOutPath)
