###
# The output of this script is used in figures 2-3
#
# use the output of the trained linear model, and the matrix produced in the
# previous script to compute the expected number of chitinases for our marine
# isolates. The agreement (or disagreement) between the observed number of
# chitinases, and the expected number of chitinases is used at the end of the
# script to classify genomes.
###

# load libraries
library(phytools,quietly=T)
library(glmnet,quietly=T)
rm(list=ls())

module_count_path <- "../output/module_count.RData"
random_forest_path <- "../output/l1_lm.RData"
clsf_path <- '../output/gtdbtk/gtdbtk.bac120.summary.tsv'
tree_path <- '../output/gtdbtk/binary.tree'
iso_gtdbtk_path <- paste0('/nfs/corderolab001/corderolab/Shared/Genomes/',
			  'gtdbtk_release89/gtdbtk.bac120.summary.tsv')
load('../output/isolate_analysis/isolates.RData')
load(module_count_path)
load(random_forest_path)
#isolateMdlMat <- t(isolateMdlMat)

# read tree
tre <- read.tree(tree_path)
tre <- keep.tip(tre,tre$tip.label[grepl('[.]fna$',tre$tip.label)])
tre$tip.label <- gsub('[.]fna','',tre$tip.label)

# remove extremely long branches
todel <- tre$edge[tre$edge.length>1,2]
todel <- tre$tip.label[todel]
tre <- drop.tip(tre,todel)

# read classifications
clsf <- read.table(clsf_path,sep='\t',header=T)
clsf$user_genome <- gsub('[.]fna','',clsf$user_genome)
clsf <- clsf[clsf$user_genome %in% tre$tip.label,]

# filter mdl and chi to only contain proteo and bacteroidetes
tokeep <- clsf$user_genome[grepl('Proteobacteria|Bacteroide',clsf$classification)]
mdl <- mdl[tokeep]
chi <- chi[tokeep]

# read in isolate gtdbtk classification
iso_clsf <- read.table(iso_gtdbtk_path,sep='\t',header=T)
iso_phy <- regmatches(iso_clsf[,2],regexpr('p__[^;]+',iso_clsf[,2]))
iso_phy <- gsub('^p__','',iso_phy)
iso_cls <- regmatches(iso_clsf[,2],regexpr('c__[^;]+',iso_clsf[,2]))
iso_cls <- gsub('^c__','',iso_cls)
pro_idx <- iso_phy=='Proteobacteria'
iso_phy[pro_idx] <- iso_cls[pro_idx]
names(iso_phy) <- iso_clsf[,1]

# classify isolates
pr <- rep(0,length(isolateChi))
names(pr) <- names(isolateChi)
pr <- pr[names(pr) %in% rownames(isolateMdlMat)]
for(phy in unique(iso_phy)){
	message(phy)
	isoNms <- names(iso_phy)[iso_phy==phy]
	isoNms <- isoNms[isoNms %in% rownames(isolateMdlMat)]
	#phy <- "all"
  col.tokeep <- rownames(coef(rf_list[[phy]]))[-1]
	pr[isoNms] <- predict(rf_list[[phy]],
												isolateMdlMat[isoNms,col.tokeep,drop=F])
}
isoDF <- data.frame(obsChi=isolateChi,preChi=pr[names(isolateChi)],
                    class='',phy=iso_phy[names(isolateChi)])
rpred <- isoDF[,2]
rpt <- .5
isoDF$class[isoDF[,1]>=1 & rpred>=rpt] <- 'degrader'
isoDF$class[isoDF[,1]<1 & rpred<rpt] <- 'crossfeeder'
isoDF$class[isoDF[,1]<1 & rpred>=rpt] <- 'exploiter'
isoDF <- isoDF[order(rownames(isoDF)),]

table(isoDF[,3])

write.table(isoDF,
						file='../output/isolate_analysis/isolate_classification.tsv',
						sep="\t")
